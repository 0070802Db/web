<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึกการออมเงินนักเรียน</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f0f9ff;
        }
        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        .card:hover {
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-color: #3b82f6;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-success {
            background-color: #10b981;
            transition: all 0.3s ease;
        }
        .btn-success:hover {
            background-color: #059669;
        }
        .btn-danger {
            background-color: #ef4444;
            transition: all 0.3s ease;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .btn-secondary {
            background-color: #6b7280;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .tab-active {
            background-color: #3b82f6;
            color: white;
        }
        .tab {
            transition: all 0.3s ease;
        }
        .tab:hover:not(.tab-active) {
            background-color: #e0e7ff;
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <header class="mb-8">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <h1 class="text-3xl font-bold text-blue-800 mb-4 md:mb-0">ระบบบันทึกการออมเงินนักเรียน</h1>
                <div id="loginSection">
                    <button id="loginBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition">เข้าสู่ระบบ</button>
                </div>
            </div>
            <div id="adminInfo" class="mt-2 text-green-600 font-medium hidden">
                คุณกำลังใช้งานในโหมดผู้ดูแลระบบ
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- ส่วนซ้าย: บันทึกการออม และรายการออมเงินประจำวัน -->
            <div class="lg:col-span-1">
                <!-- บันทึกการออม -->
                <div class="bg-white rounded-xl p-6 card">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">บันทึกการออมเงิน</h2>
                    
                    <div class="mb-4">
                        <label for="savingDate" class="block text-gray-700 mb-1">วันที่บันทึก</label>
                        <input type="date" id="savingDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div class="mb-4">
                        <label for="studentSelect" class="block text-gray-700 mb-1">ชื่อนักเรียน</label>
                        <select id="studentSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">-- เลือกนักเรียน --</option>
                        </select>
                    </div>
                    
                    <div class="mb-6">
                        <label for="amount" class="block text-gray-700 mb-1">จำนวนเงินฝาก (บาท)</label>
                        <input type="number" id="amount" min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="0.00">
                    </div>
                    
                    <button id="saveBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition">บันทึกการออม</button>
                </div>

                <!-- รายการออมเงินประจำวัน (ย้ายมาไว้ตรงนี้) -->
                <div id="dailyDepositsContainer" class="bg-white rounded-xl p-6 mt-6 card">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">รายการออมเงินประจำวัน</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="py-2 px-4 border-b text-left">ชื่อนักเรียน</th>
                                    <th class="py-2 px-4 border-b text-right">จำนวนเงิน (บาท)</th>
                                </tr>
                            </thead>
                            <tbody id="dailyDepositsData">
                                <tr>
                                    <td colspan="2" class="py-4 text-center text-gray-500">ไม่พบข้อมูล</td>
                                </tr>
                            </tbody>
                            <tfoot class="bg-gray-50">
                                <tr>
                                    <td class="py-2 px-4 border-t font-medium">รวมทั้งสิ้น</td>
                                    <td id="dailyTotal" class="py-2 px-4 border-t text-right font-medium">0.00</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- จัดการรายชื่อนักเรียน (Admin only) -->
                <div id="adminPanel" class="bg-white rounded-xl p-6 mt-6 card hidden">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">จัดการรายชื่อนักเรียน</h2>
                    
                    <div class="mb-4">
                        <label for="newStudent" class="block text-gray-700 mb-1">เพิ่มนักเรียนใหม่</label>
                        <div class="flex">
                            <input type="text" id="newStudent" class="flex-1 px-3 py-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ชื่อ-นามสกุล">
                            <button id="addStudentBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-r-lg transition">เพิ่ม</button>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="removeStudent" class="block text-gray-700 mb-1">ลบรายชื่อนักเรียน</label>
                        <div class="flex">
                            <select id="removeStudent" class="flex-1 px-3 py-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">-- เลือกนักเรียน --</option>
                            </select>
                            <button id="removeStudentBtn" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-r-lg transition">ลบ</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- สถิติการออม -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl p-6 card">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">สถิติการออมเงิน</h2>
                    
                    <!-- Tabs -->
                    <div class="flex flex-wrap mb-6 border-b">
                        <button class="tab tab-active px-4 py-2 rounded-t-lg" data-tab="daily">รายวัน</button>
                        <button class="tab px-4 py-2 rounded-t-lg" data-tab="monthly">รายเดือน</button>
                        <button class="tab px-4 py-2 rounded-t-lg" data-tab="yearly">รายปี</button>
                    </div>
                    
                    <!-- Filter Controls -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div id="dateFilterContainer">
                            <label for="dateFilter" class="block text-gray-700 mb-1">วันที่</label>
                            <input type="date" id="dateFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div id="monthFilterContainer" class="hidden">
                            <label for="monthFilter" class="block text-gray-700 mb-1">เดือน</label>
                            <select id="monthFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="1">มกราคม</option>
                                <option value="2">กุมภาพันธ์</option>
                                <option value="3">มีนาคม</option>
                                <option value="4">เมษายน</option>
                                <option value="5">พฤษภาคม</option>
                                <option value="6">มิถุนายน</option>
                                <option value="7">กรกฎาคม</option>
                                <option value="8">สิงหาคม</option>
                                <option value="9">กันยายน</option>
                                <option value="10">ตุลาคม</option>
                                <option value="11">พฤศจิกายน</option>
                                <option value="12">ธันวาคม</option>
                            </select>
                        </div>
                        
                        <div id="yearFilterContainer">
                            <label for="yearFilter" class="block text-gray-700 mb-1">ปี</label>
                            <select id="yearFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </select>
                        </div>
                        
                        <div class="md:col-span-3">
                            <button id="generateReportBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition">แสดงรายงาน</button>
                        </div>
                    </div>
                    
                    <!-- Summary Card -->
                    <div id="reportSummary" class="mb-6 p-4 bg-blue-50 rounded-lg">
                        <div class="text-lg font-medium text-blue-800">สรุปข้อมูลการออมเงิน</div>
                        <div id="summaryContent" class="mt-2 grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-white p-3 rounded-lg shadow">
                                <div class="text-sm text-gray-500">จำนวนนักเรียนที่ออม</div>
                                <div id="studentCount" class="text-2xl font-bold text-blue-600">0 คน</div>
                            </div>
                            <div class="bg-white p-3 rounded-lg shadow">
                                <div class="text-sm text-gray-500">จำนวนรายการออม</div>
                                <div id="transactionCount" class="text-2xl font-bold text-green-600">0 รายการ</div>
                            </div>
                            <div class="bg-white p-3 rounded-lg shadow">
                                <div class="text-sm text-gray-500">ยอดเงินรวม</div>
                                <div id="totalAmount" class="text-2xl font-bold text-purple-600">0.00 บาท</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Report Data Table -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border">
                            <thead class="bg-gray-100">
                                <tr id="reportTableHeader">
                                    <th class="py-2 px-4 border-b text-left">วันที่</th>
                                    <th class="py-2 px-4 border-b text-left">ชื่อนักเรียน</th>
                                    <th class="py-2 px-4 border-b text-right">จำนวนเงิน (บาท)</th>
                                </tr>
                            </thead>
                            <tbody id="reportData">
                                <tr>
                                    <td colspan="3" class="py-4 text-center text-gray-500">ไม่พบข้อมูล</td>
                                </tr>
                            </tbody>
                            <tfoot class="bg-gray-50">
                                <tr>
                                    <td id="reportFooterLabel" colspan="2" class="py-2 px-4 border-t font-medium">รวมทั้งสิ้น</td>
                                    <td id="reportTotal" class="py-2 px-4 border-t text-right font-medium">0.00</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    

    <script>
        // Global variables
        const API_URL = 'https://script.google.com/macros/s/AKfycbw4SOR3ihWKVknvayIwtYi8uOWF8-MFiYCJd1a3a3MJH77Vby2_EvHP6lS2zNwH6MM/exec';
        let isAdmin = false;
        let students = [];
        let savingsData = [];
        let currentTab = 'daily';

        // DOM Elements
        const loginBtn = document.getElementById('loginBtn');
        const loginModal = document.getElementById('loginModal');
        const cancelLoginBtn = document.getElementById('cancelLoginBtn');
        const submitLoginBtn = document.getElementById('submitLoginBtn');
        const username = document.getElementById('username');
        const password = document.getElementById('password');
        const adminInfo = document.getElementById('adminInfo');
        const adminPanel = document.getElementById('adminPanel');
        const studentSelect = document.getElementById('studentSelect');
        const removeStudent = document.getElementById('removeStudent');
        const savingDate = document.getElementById('savingDate');
        const amount = document.getElementById('amount');
        const saveBtn = document.getElementById('saveBtn');
        const addStudentBtn = document.getElementById('addStudentBtn');
        const removeStudentBtn = document.getElementById('removeStudentBtn');
        const newStudent = document.getElementById('newStudent');
        const dateFilter = document.getElementById('dateFilter');
        const monthFilter = document.getElementById('monthFilter');
        const yearFilter = document.getElementById('yearFilter');
        const generateReportBtn = document.getElementById('generateReportBtn');
        const reportData = document.getElementById('reportData');
        const reportTableHeader = document.getElementById('reportTableHeader');
        const reportFooterLabel = document.getElementById('reportFooterLabel');
        const reportTotal = document.getElementById('reportTotal');
        const dailyDepositsData = document.getElementById('dailyDepositsData');
        const dailyTotal = document.getElementById('dailyTotal');
        const studentCount = document.getElementById('studentCount');
        const transactionCount = document.getElementById('transactionCount');
        const totalAmount = document.getElementById('totalAmount');
        const tabs = document.querySelectorAll('.tab');
        const dateFilterContainer = document.getElementById('dateFilterContainer');
        const monthFilterContainer = document.getElementById('monthFilterContainer');
        const yearFilterContainer = document.getElementById('yearFilterContainer');

        // Set default date to today
        const today = new Date();
        const todayFormatted = formatDateForInput(today);
        savingDate.value = todayFormatted;
        dateFilter.value = todayFormatted;

        // Populate year filter with last 5 years
        const currentYear = today.getFullYear();
        for (let year = currentYear; year >= currentYear - 4; year--) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            yearFilter.appendChild(option);
        }
        yearFilter.value = currentYear;

        // Set current month
        monthFilter.value = (today.getMonth() + 1).toString();

        // Event Listeners
        loginBtn.addEventListener('click', showLoginModal);
        cancelLoginBtn.addEventListener('click', hideLoginModal);
        submitLoginBtn.addEventListener('click', handleLogin);
        saveBtn.addEventListener('click', saveSavingsData);
        addStudentBtn.addEventListener('click', addStudent);
        removeStudentBtn.addEventListener('click', removeStudentHandler);
        generateReportBtn.addEventListener('click', generateReport);
        
        // Tab switching
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('tab-active'));
                tab.classList.add('tab-active');
                currentTab = tab.dataset.tab;
                updateFilterVisibility();
            });
        });

        // Initialize
        fetchStudents();
        fetchSavingsData();
        updateFilterVisibility();
        fetchDailyDeposits();

        // JSONP Helper Functions
        function jsonpRequest(url, callback) {
            const script = document.createElement('script');
            const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
            
            window[callbackName] = function(data) {
                delete window[callbackName];
                document.body.removeChild(script);
                callback(data);
            };
            
            script.src = url + (url.indexOf('?') >= 0 ? '&' : '?') + 'callback=' + callbackName;
            document.body.appendChild(script);
        }

        // Login Functions
        function showLoginModal() {
            loginModal.classList.remove('hidden');
            username.focus();
        }

        function hideLoginModal() {
            loginModal.classList.add('hidden');
            username.value = '';
            password.value = '';
        }

        function handleLogin() {
            const user = username.value;
            const pass = password.value;
            
            if (user === 'admin' && pass === '1234') {
                isAdmin = true;
                adminInfo.classList.remove('hidden');
                adminPanel.classList.remove('hidden');
                loginBtn.textContent = 'ออกจากระบบ';
                loginBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                loginBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                loginBtn.removeEventListener('click', showLoginModal);
                loginBtn.addEventListener('click', handleLogout);
                hideLoginModal();
                
                Swal.fire({
                    icon: 'success',
                    title: 'เข้าสู่ระบบสำเร็จ',
                    text: 'คุณได้เข้าสู่ระบบในฐานะผู้ดูแลระบบ',
                    confirmButtonText: 'ตกลง',
                    confirmButtonColor: '#3b82f6'
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'เข้าสู่ระบบไม่สำเร็จ',
                    text: 'ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง',
                    confirmButtonText: 'ลองใหม่',
                    confirmButtonColor: '#3b82f6'
                });
            }
        }

        function handleLogout() {
            isAdmin = false;
            adminInfo.classList.add('hidden');
            adminPanel.classList.add('hidden');
            loginBtn.textContent = 'เข้าสู่ระบบ';
            loginBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
            loginBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            loginBtn.removeEventListener('click', handleLogout);
            loginBtn.addEventListener('click', showLoginModal);
            
            Swal.fire({
                icon: 'success',
                title: 'ออกจากระบบสำเร็จ',
                text: 'คุณได้ออกจากระบบผู้ดูแลแล้ว',
                confirmButtonText: 'ตกลง',
                confirmButtonColor: '#3b82f6'
            });
        }

        // Data Fetching Functions
        function fetchStudents() {
            Swal.fire({
                title: 'กำลังโหลดข้อมูล',
                text: 'กรุณารอสักครู่...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            jsonpRequest(`${API_URL}?action=getStudents`, function(data) {
                students = data.students || [];
                updateStudentSelects();
                Swal.close();
            });
        }

        function fetchSavingsData() {
            jsonpRequest(`${API_URL}?action=getSavings`, function(data) {
                savingsData = data.savings || [];
            });
        }

        function fetchDailyDeposits() {
            const today = new Date().toISOString().split('T')[0];
            
            jsonpRequest(`${API_URL}?action=getDailyDeposits&date=${today}`, function(data) {
                if (data.success) {
                    displayDailyDeposits(data.deposits);
                }
            });
        }

        function updateStudentSelects() {
            // Clear existing options
            studentSelect.innerHTML = '<option value="">-- เลือกนักเรียน --</option>';
            removeStudent.innerHTML = '<option value="">-- เลือกนักเรียน --</option>';
            
            // Add student options
            students.forEach(student => {
                const option1 = document.createElement('option');
                option1.value = student;
                option1.textContent = student;
                studentSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = student;
                option2.textContent = student;
                removeStudent.appendChild(option2);
            });
        }

        // Student Management Functions
        function addStudent() {
            const studentName = newStudent.value.trim();
            
            if (!studentName) {
                Swal.fire({
                    icon: 'warning',
                    title: 'ข้อมูลไม่ครบถ้วน',
                    text: 'กรุณากรอกชื่อนักเรียน',
                    confirmButtonText: 'ตกลง',
                    confirmButtonColor: '#3b82f6'
                });
                return;
            }
            
            if (!isAdmin) {
                Swal.fire({
                    icon: 'error',
                    title: 'ไม่มีสิทธิ์',
                    text: 'คุณไม่มีสิทธิ์ในการเพิ่มนักเรียน',
                    confirmButtonText: 'ตกลง',
                    confirmButtonColor: '#3b82f6'
                });
                return;
            }
            
            Swal.fire({
                title: 'กำลังบันทึกข้อมูล',
                text: 'กรุณารอสักครู่...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            jsonpRequest(`${API_URL}?action=addStudent&name=${encodeURIComponent(studentName)}`, function(data) {
                if (data.success) {
                    newStudent.value = '';
                    fetchStudents();
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'เพิ่มนักเรียนสำเร็จ',
                        text: `เพิ่ม ${studentName} เรียบร้อยแล้ว`,
                        confirmButtonText: 'ตกลง',
                        confirmButtonColor: '#3b82f6'
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'เพิ่มนักเรียนไม่สำเร็จ',
                        text: data.message || 'เกิดข้อผิดพลาด กรุณาลองใหม่อีกครั้ง',
                        confirmButtonText: 'ตกลง',
                        confirmButtonColor: '#3b82f6'
                    });
                }
            });
        }

        function removeStudentHandler() {
            const studentName = removeStudent.value;
            
            if (!studentName) {
                Swal.fire({
                    icon: 'warning',
                    title: 'ข้อมูลไม่ครบถ้วน',
                    text: 'กรุณาเลือกนักเรียนที่ต้องการลบ',
                    confirmButtonText: 'ตกลง',
                    confirmButtonColor: '#3b82f6'
                });
                return;
            }
            
            if (!isAdmin) {
                Swal.fire({
                    icon: 'error',
                    title: 'ไม่มีสิทธิ์',
                    text: 'คุณไม่มีสิทธิ์ในการลบนักเรียน',
                    confirmButtonText: 'ตกลง',
                    confirmButtonColor: '#3b82f6'
                });
                return;
            }
            
            Swal.fire({
                title: 'ยืนยันการลบ',
                text: `คุณต้องการลบ ${studentName} ใช่หรือไม่?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ใช่, ลบเลย',
                cancelButtonText: 'ยกเลิก',
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'กำลังลบข้อมูล',
                        text: 'กรุณารอสักครู่...',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    jsonpRequest(`${API_URL}?action=removeStudent&name=${encodeURIComponent(studentName)}`, function(data) {
                        if (data.success) {
                            fetchStudents();
                            fetchSavingsData();
                            fetchDailyDeposits();
                            
                            Swal.fire({
                                icon: 'success',
                                title: 'ลบนักเรียนสำเร็จ',
                                text: `ลบ ${studentName} เรียบร้อยแล้ว`,
                                confirmButtonText: 'ตกลง',
                                confirmButtonColor: '#3b82f6'
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'ลบนักเรียนไม่สำเร็จ',
                                text: data.message || 'เกิดข้อผิดพลาด กรุณาลองใหม่อีกครั้ง',
                                confirmButtonText: 'ตกลง',
                                confirmButtonColor: '#3b82f6'
                            });
                        }
                    });
                }
            });
        }

        // Savings Functions
        function saveSavingsData() {
            const date = savingDate.value;
            const student = studentSelect.value;
            const amountValue = parseFloat(amount.value);
            
            if (!date || !student || isNaN(amountValue) || amountValue <= 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'ข้อมูลไม่ครบถ้วน',
                    text: 'กรุณากรอกข้อมูลให้ครบถ้วน',
                    confirmButtonText: 'ตกลง',
                    confirmButtonColor: '#3b82f6'
                });
                return;
            }
            
            Swal.fire({
                title: 'กำลังบันทึกข้อมูล',
                text: 'กรุณารอสักครู่...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            jsonpRequest(`${API_URL}?action=saveSavings&date=${encodeURIComponent(date)}&student=${encodeURIComponent(student)}&amount=${amountValue}`, function(data) {
                if (data.success) {
                    amount.value = '';
                    fetchSavingsData();
                    fetchDailyDeposits();
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'บันทึกข้อมูลสำเร็จ',
                        text: `บันทึกการออมเงินของ ${student} จำนวน ${amountValue.toFixed(2)} บาท เรียบร้อยแล้ว`,
                        confirmButtonText: 'ตกลง',
                        confirmButtonColor: '#3b82f6'
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'บันทึกข้อมูลไม่สำเร็จ',
                        text: data.message || 'เกิดข้อผิดพลาด กรุณาลองใหม่อีกครั้ง',
                        confirmButtonText: 'ตกลง',
                        confirmButtonColor: '#3b82f6'
                    });
                }
            });
        }

        // Report Functions
        function updateFilterVisibility() {
            // Reset visibility
            dateFilterContainer.style.display = 'block';
            monthFilterContainer.style.display = 'none';
            yearFilterContainer.style.display = 'block';
            
            // Adjust filters based on report type
            switch (currentTab) {
                case 'daily':
                    // Show date and year filters
                    break;
                case 'monthly':
                    // Show month and year filters
                    dateFilterContainer.style.display = 'none';
                    monthFilterContainer.style.display = 'block';
                    break;
                case 'yearly':
                    // Show only year filter
                    dateFilterContainer.style.display = 'none';
                    break;
            }
        }

        function generateReport() {
            let params = `action=getReport&type=${currentTab}`;
            
            switch (currentTab) {
                case 'daily':
                    params += `&date=${dateFilter.value}&year=${yearFilter.value}`;
                    break;
                case 'monthly':
                    params += `&month=${monthFilter.value}&year=${yearFilter.value}`;
                    break;
                case 'yearly':
                    params += `&year=${yearFilter.value}`;
                    break;
            }
            
            Swal.fire({
                title: 'กำลังสร้างรายงาน',
                text: 'กรุณารอสักครู่...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            jsonpRequest(`${API_URL}?${params}`, function(data) {
                if (data.success) {
                    displayReport(data.report, currentTab);
                    updateSummary(data.summary);
                    Swal.close();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'สร้างรายงานไม่สำเร็จ',
                        text: data.message || 'เกิดข้อผิดพลาด กรุณาลองใหม่อีกครั้ง',
                        confirmButtonText: 'ตกลง',
                        confirmButtonColor: '#3b82f6'
                    });
                }
            });
        }

        function displayDailyDeposits(deposits) {
            dailyDepositsData.innerHTML = '';
            
            if (deposits && deposits.length > 0) {
                let total = 0;
                
                deposits.forEach(item => {
                    const row = document.createElement('tr');
                    
                    const studentCell = document.createElement('td');
                    studentCell.className = 'py-2 px-4 border-b';
                    studentCell.textContent = item.student;
                    row.appendChild(studentCell);
                    
                    const amountCell = document.createElement('td');
                    amountCell.className = 'py-2 px-4 border-b text-right';
                    amountCell.textContent = formatCurrency(item.amount);
                    row.appendChild(amountCell);
                    
                    dailyDepositsData.appendChild(row);
                    
                    total += parseFloat(item.amount);
                });
                
                dailyTotal.textContent = formatCurrency(total);
            } else {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 2;
                cell.className = 'py-4 text-center text-gray-500';
                cell.textContent = 'ไม่พบข้อมูลการออมเงินวันนี้';
                row.appendChild(cell);
                dailyDepositsData.appendChild(row);
                
                dailyTotal.textContent = '0.00';
            }
        }

        function displayReport(report, type) {
            // Update table header based on report type
            reportTableHeader.innerHTML = '';
            let headerRow = document.createElement('tr');
            
            switch (type) {
                case 'daily':
                    headerRow.innerHTML = `
                        <th class="py-2 px-4 border-b text-left">ชื่อนักเรียน</th>
                        <th class="py-2 px-4 border-b text-right">จำนวนเงิน (บาท)</th>
                    `;
                    reportFooterLabel.colSpan = 1;
                    break;
                case 'monthly':
                    headerRow.innerHTML = `
                        <th class="py-2 px-4 border-b text-left">วันที่</th>
                        <th class="py-2 px-4 border-b text-left">ชื่อนักเรียน</th>
                        <th class="py-2 px-4 border-b text-right">จำนวนเงิน (บาท)</th>
                    `;
                    reportFooterLabel.colSpan = 2;
                    break;
                case 'yearly':
                    headerRow.innerHTML = `
                        <th class="py-2 px-4 border-b text-left">เดือน</th>
                        <th class="py-2 px-4 border-b text-left">ชื่อนักเรียน</th>
                        <th class="py-2 px-4 border-b text-right">จำนวนเงิน (บาท)</th>
                    `;
                    reportFooterLabel.colSpan = 2;
                    break;
            }
            
            reportTableHeader.appendChild(headerRow);
            
            // Update table data
            reportData.innerHTML = '';
            
            if (report && report.length > 0) {
                let total = 0;
                
                report.forEach(item => {
                    const row = document.createElement('tr');
                    
                    switch (type) {
                        case 'daily':
                            const studentCell = document.createElement('td');
                            studentCell.className = 'py-2 px-4 border-b';
                            studentCell.textContent = item.student;
                            row.appendChild(studentCell);
                            
                            const amountCell = document.createElement('td');
                            amountCell.className = 'py-2 px-4 border-b text-right';
                            amountCell.textContent = formatCurrency(item.amount);
                            row.appendChild(amountCell);
                            break;
                            
                        case 'monthly':
                            const dateCell = document.createElement('td');
                            dateCell.className = 'py-2 px-4 border-b';
                            dateCell.textContent = item.date;
                            row.appendChild(dateCell);
                            
                            const studentCellMonthly = document.createElement('td');
                            studentCellMonthly.className = 'py-2 px-4 border-b';
                            studentCellMonthly.textContent = item.student;
                            row.appendChild(studentCellMonthly);
                            
                            const amountCellMonthly = document.createElement('td');
                            amountCellMonthly.className = 'py-2 px-4 border-b text-right';
                            amountCellMonthly.textContent = formatCurrency(item.amount);
                            row.appendChild(amountCellMonthly);
                            break;
                            
                        case 'yearly':
                            const monthCell = document.createElement('td');
                            monthCell.className = 'py-2 px-4 border-b';
                            monthCell.textContent = item.month;
                            row.appendChild(monthCell);
                            
                            const studentCellYearly = document.createElement('td');
                            studentCellYearly.className = 'py-2 px-4 border-b';
                            studentCellYearly.textContent = item.student;
                            row.appendChild(studentCellYearly);
                            
                            const amountCellYearly = document.createElement('td');
                            amountCellYearly.className = 'py-2 px-4 border-b text-right';
                            amountCellYearly.textContent = formatCurrency(item.amount);
                            row.appendChild(amountCellYearly);
                            break;
                    }
                    
                    reportData.appendChild(row);
                    total += parseFloat(item.amount);
                });
                
                reportTotal.textContent = formatCurrency(total);
            } else {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = type === 'daily' ? 2 : 3;
                cell.className = 'py-4 text-center text-gray-500';
                cell.textContent = 'ไม่พบข้อมูล';
                row.appendChild(cell);
                reportData.appendChild(row);
                
                reportTotal.textContent = '0.00';
            }
        }

        function updateSummary(summary) {
            if (summary) {
                studentCount.textContent = `${summary.studentCount} คน`;
                transactionCount.textContent = `${summary.transactionCount} รายการ`;
                totalAmount.textContent = `${formatCurrency(summary.totalAmount)} บาท`;
            } else {
                studentCount.textContent = '0 คน';
                transactionCount.textContent = '0 รายการ';
                totalAmount.textContent = '0.00 บาท';
            }
        }

        // Helper Functions
        function formatDate(dateString) {
            const date = new Date(dateString);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function formatDateForInput(date) {
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${year}-${month}-${day}`;
        }

        function formatCurrency(amount) {
            return parseFloat(amount).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }

        function getThaiMonth(month) {
            const months = [
                'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
                'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'
            ];
            return months[month - 1];
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'943a7667d6b7fdf2',t:'MTc0Nzg5NzQ5OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
