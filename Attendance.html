<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึกการมาเรียนของนักเรียน</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f0f9ff;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* สีพื้นหลังสำหรับตัวเลือกสถานะการมาเรียน */
        .attendance-status option[value="present"] {
            background-color: #4ade80; /* สีเขียว */
            color: white;
        }
        .attendance-status option[value="absent"] {
            background-color: #f87171; /* สีแดง */
            color: white;
        }
        .attendance-status option[value="sick"] {
            background-color: #60a5fa; /* สีฟ้า */
            color: white;
        }
        .attendance-status option[value="personal"] {
            background-color: #fb923c; /* สีส้ม */
            color: white;
        }
        
        /* สีพื้นหลังสำหรับ select เมื่อเลือกสถานะต่างๆ */
        .status-present {
            background-color: #4ade80 !important; /* สีเขียว */
            color: white !important;
        }
        .status-absent {
            background-color: #f87171 !important; /* สีแดง */
            color: white !important;
        }
        .status-sick {
            background-color: #60a5fa !important; /* สีฟ้า */
            color: white !important;
        }
        .status-personal {
            background-color: #fb923c !important; /* สีส้ม */
            color: white !important;
        }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <header class="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-6 rounded-lg shadow-lg mb-6">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl md:text-3xl font-bold">ระบบบันทึกการมาเรียนของนักเรียน</h1>
                <div>
                    <button id="loginBtn" class="bg-white text-blue-700 px-4 py-2 rounded-lg font-medium hover:bg-blue-100 transition">เข้าสู่ระบบ</button>
                    <button id="logoutBtn" class="hidden bg-red-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-600 transition">ออกจากระบบ</button>
                </div>
            </div>
            <div id="adminBadge" class="hidden mt-2 bg-yellow-400 text-blue-900 px-3 py-1 rounded-full inline-block font-medium">
                โหมดผู้ดูแลระบบ
            </div>
        </header>

        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
                <div class="flex flex-col md:flex-row md:items-center gap-4">
                    <div>
                        <label for="attendanceDate" class="block text-gray-700 font-medium mb-1">วันที่บันทึก</label>
                        <input type="date" id="attendanceDate" class="border border-gray-300 rounded-md px-3 py-2 w-full">
                    </div>
                    <div class="mt-2 md:mt-0">
                        <label class="block text-gray-700 font-medium mb-1">ประเภทวัน</label>
                        <div class="flex items-center space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="dayType" value="normal" checked class="form-radio text-blue-600">
                                <span class="ml-2">วันทำการ</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="dayType" value="holiday" class="form-radio text-blue-600">
                                <span class="ml-2">วันหยุด</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div>
                    <button id="viewStatsBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-700 transition">ดูสถิติการมาเรียน</button>
                </div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">รายชื่อนักเรียน</h2>
                <button id="addStudentBtn" class="hidden bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition">เพิ่มนักเรียน</button>
            </div>
            
            <div id="studentList" class="space-y-4">
                <!-- Student list will be generated here -->
                <div class="text-center text-gray-500 py-4">กำลังโหลดข้อมูล...</div>
            </div>
            
            <div class="mt-6 text-center">
                <button id="saveAttendanceBtn" class="bg-green-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-green-700 transition text-lg">บันทึกข้อมูลการมาเรียน</button>
            </div>
        </div>

        <!-- Login Modal -->
        <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg p-6 w-full max-w-md">
                <h2 class="text-xl font-bold mb-4">เข้าสู่ระบบผู้ดูแล</h2>
                <div class="mb-4">
                    <label for="username" class="block text-gray-700 font-medium mb-1">ชื่อผู้ใช้</label>
                    <input type="text" id="username" class="border border-gray-300 rounded-md px-3 py-2 w-full" placeholder="ชื่อผู้ใช้">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-gray-700 font-medium mb-1">รหัสผ่าน</label>
                    <input type="password" id="password" class="border border-gray-300 rounded-md px-3 py-2 w-full" placeholder="รหัสผ่าน">
                </div>
                <div class="flex justify-end space-x-3">
                    <button id="cancelLoginBtn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-medium hover:bg-gray-400 transition">ยกเลิก</button>
                    <button id="submitLoginBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition">เข้าสู่ระบบ</button>
                </div>
            </div>
        </div>

        <!-- Add Student Modal -->
        <div id="addStudentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg p-6 w-full max-w-md">
                <h2 class="text-xl font-bold mb-4">เพิ่มนักเรียน</h2>
                <div class="mb-4">
                    <label for="studentPrefix" class="block text-gray-700 font-medium mb-1">คำนำหน้า</label>
                    <select id="studentPrefix" class="border border-gray-300 rounded-md px-3 py-2 w-full">
                        <option value="ด.ช.">ด.ช.</option>
                        <option value="ด.ญ.">ด.ญ.</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label for="studentName" class="block text-gray-700 font-medium mb-1">ชื่อ-นามสกุล</label>
                    <input type="text" id="studentName" class="border border-gray-300 rounded-md px-3 py-2 w-full" placeholder="ชื่อ-นามสกุล">
                </div>
                <div class="flex justify-end space-x-3">
                    <button id="cancelAddStudentBtn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-medium hover:bg-gray-400 transition">ยกเลิก</button>
                    <button id="submitAddStudentBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition">เพิ่มนักเรียน</button>
                </div>
            </div>
        </div>

        <!-- Stats Modal -->
        <div id="statsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">สถิติการมาเรียน</h2>
                    <button id="closeStatsBtn" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                
                <div class="mb-4">
                    <div class="flex flex-wrap gap-3 mb-4">
                        <button class="stats-tab bg-blue-600 text-white px-4 py-2 rounded-lg font-medium" data-tab="individual">รายบุคคล</button>
                        <button class="stats-tab bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-medium" data-tab="daily">รายวัน</button>
                        <button class="stats-tab bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-medium" data-tab="monthly">รายเดือน</button>
                    </div>
                    
                    <div class="mb-4">
                        <label for="statsMonth" class="block text-gray-700 font-medium mb-1">เลือกเดือน</label>
                        <input type="month" id="statsMonth" class="border border-gray-300 rounded-md px-3 py-2">
                    </div>
                    
                    <div id="individualStats" class="stats-content">
                        <div class="mb-4">
                            <label for="selectStudent" class="block text-gray-700 font-medium mb-1">เลือกนักเรียน</label>
                            <select id="selectStudent" class="border border-gray-300 rounded-md px-3 py-2 w-full">
                                <!-- Student options will be generated here -->
                            </select>
                        </div>
                        <div id="individualStatsContent" class="mt-4">
                            <!-- Individual stats will be shown here -->
                        </div>
                    </div>
                    
                    <div id="dailyStats" class="stats-content hidden">
                        <div class="mb-4">
                            <label for="selectDate" class="block text-gray-700 font-medium mb-1">เลือกวันที่</label>
                            <input type="date" id="selectDate" class="border border-gray-300 rounded-md px-3 py-2">
                        </div>
                        <div id="dailyStatsContent" class="mt-4">
                            <!-- Daily stats will be shown here -->
                        </div>
                    </div>
                    
                    <div id="monthlyStats" class="stats-content hidden">
                        <div id="monthlyStatsContent" class="mt-4">
                            <!-- Monthly stats will be shown here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let isAdmin = false;
        let students = [];
        let attendanceData = {};
        const API_URL = 'https://script.google.com/macros/s/AKfycbwOvbMfmO7Wl2uUPlnNxUbXpOedVBjUNHgJTQpRGH1Z5OAAjXkS_RzKyGqCvQBhW3Z0/exec';
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            // Set today's date as default
            const today = new Date();
            document.getElementById('attendanceDate').value = formatDate(today);
            document.getElementById('statsMonth').value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            document.getElementById('selectDate').value = formatDate(today);
            
            // Load students
            loadStudents();
            
            // Setup event listeners
            setupEventListeners();
        });
        
        function formatDate(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }
        
        function setupEventListeners() {
            // Login/Logout
            document.getElementById('loginBtn').addEventListener('click', showLoginModal);
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('cancelLoginBtn').addEventListener('click', hideLoginModal);
            document.getElementById('submitLoginBtn').addEventListener('click', login);
            
            // Add Student
            document.getElementById('addStudentBtn').addEventListener('click', showAddStudentModal);
            document.getElementById('cancelAddStudentBtn').addEventListener('click', hideAddStudentModal);
            document.getElementById('submitAddStudentBtn').addEventListener('click', addStudent);
            
            // Save Attendance
            document.getElementById('saveAttendanceBtn').addEventListener('click', saveAttendance);
            
            // Stats
            document.getElementById('viewStatsBtn').addEventListener('click', showStatsModal);
            document.getElementById('closeStatsBtn').addEventListener('click', hideStatsModal);
            
            // Stats tabs
            document.querySelectorAll('.stats-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    switchStatsTab(tab.dataset.tab);
                });
            });
            
            // Stats filters
            document.getElementById('selectStudent').addEventListener('change', loadIndividualStats);
            document.getElementById('selectDate').addEventListener('change', loadDailyStats);
            document.getElementById('statsMonth').addEventListener('change', () => {
                const activeTab = document.querySelector('.stats-tab.bg-blue-600').dataset.tab;
                if (activeTab === 'individual') loadIndividualStats();
                else if (activeTab === 'daily') loadDailyStats();
                else if (activeTab === 'monthly') loadMonthlyStats();
            });
        }
        
        // JSONP helper function
        function jsonpRequest(url, callback) {
            const script = document.createElement('script');
            const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
            
            window[callbackName] = function(data) {
                delete window[callbackName];
                document.body.removeChild(script);
                callback(data);
            };
            
            script.src = url + (url.indexOf('?') >= 0 ? '&' : '?') + 'callback=' + callbackName;
            document.body.appendChild(script);
        }
        
        // Authentication functions
        function showLoginModal() {
            document.getElementById('loginModal').classList.remove('hidden');
        }
        
        function hideLoginModal() {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }
        
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username === 'admin' && password === '1234') {
                isAdmin = true;
                document.getElementById('adminBadge').classList.remove('hidden');
                document.getElementById('loginBtn').classList.add('hidden');
                document.getElementById('logoutBtn').classList.remove('hidden');
                document.getElementById('addStudentBtn').classList.remove('hidden');
                hideLoginModal();
                
                // Update student list to show delete buttons
                renderStudentList();
                
                Swal.fire({
                    icon: 'success',
                    title: 'เข้าสู่ระบบสำเร็จ',
                    text: 'คุณได้เข้าสู่ระบบในฐานะผู้ดูแลระบบแล้ว',
                    confirmButtonText: 'ตกลง',
                    confirmButtonColor: '#3085d6'
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'เข้าสู่ระบบไม่สำเร็จ',
                    text: 'ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง',
                    confirmButtonText: 'ลองใหม่',
                    confirmButtonColor: '#3085d6'
                });
            }
        }
        
        function logout() {
            isAdmin = false;
            document.getElementById('adminBadge').classList.add('hidden');
            document.getElementById('loginBtn').classList.remove('hidden');
            document.getElementById('logoutBtn').classList.add('hidden');
            document.getElementById('addStudentBtn').classList.add('hidden');
            
            // Update student list to hide delete buttons
            renderStudentList();
            
            Swal.fire({
                icon: 'info',
                title: 'ออกจากระบบแล้ว',
                text: 'คุณได้ออกจากระบบผู้ดูแลแล้ว',
                confirmButtonText: 'ตกลง',
                confirmButtonColor: '#3085d6'
            });
        }
        
        // Student management functions
        function loadStudents() {
            Swal.fire({
                title: 'กำลังโหลดข้อมูล',
                text: 'กรุณารอสักครู่...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            jsonpRequest(`${API_URL}?action=getStudents`, (data) => {
                students = data.students || [];
                renderStudentList();
                populateStudentDropdown();
                Swal.close();
            });
        }
        
        function renderStudentList() {
            const studentListEl = document.getElementById('studentList');
            
            if (students.length === 0) {
                studentListEl.innerHTML = '<div class="text-center text-gray-500 py-4">ไม่พบรายชื่อนักเรียน</div>';
                return;
            }
            
            let html = '';
            students.forEach((student, index) => {
                html += `
                <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center">
                            <span class="font-medium text-lg">${index + 1}. ${student.prefix} ${student.name}</span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <select class="attendance-status border border-gray-300 rounded-md px-3 py-1" data-student-id="${student.id}" onchange="updateSelectColor(this)">
                                <option value="present">มาเรียน</option>
                                <option value="absent">ขาดเรียน</option>
                                <option value="sick">ลาป่วย</option>
                                <option value="personal">ลากิจ</option>
                            </select>
                            ${isAdmin ? `<button class="delete-student text-red-600 hover:text-red-800" data-student-id="${student.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>` : ''}
                        </div>
                    </div>
                </div>`;
            });
            
            studentListEl.innerHTML = html;
            
            // Add event listeners for delete buttons
            if (isAdmin) {
                document.querySelectorAll('.delete-student').forEach(button => {
                    button.addEventListener('click', () => {
                        const studentId = button.dataset.studentId;
                        deleteStudent(studentId);
                    });
                });
            }
            
            // Initialize select colors
            document.querySelectorAll('.attendance-status').forEach(select => {
                updateSelectColor(select);
            });
        }
        
        // Function to update select color based on selected value
        function updateSelectColor(select) {
            // Remove all status classes
            select.classList.remove('status-present', 'status-absent', 'status-sick', 'status-personal');
            
            // Add appropriate class based on selected value
            const value = select.value;
            select.classList.add(`status-${value}`);
        }
        
        function showAddStudentModal() {
            document.getElementById('addStudentModal').classList.remove('hidden');
        }
        
        function hideAddStudentModal() {
            document.getElementById('addStudentModal').classList.add('hidden');
            document.getElementById('studentName').value = '';
        }
        
        function addStudent() {
            const prefix = document.getElementById('studentPrefix').value;
            const name = document.getElementById('studentName').value.trim();
            
            if (!name) {
                Swal.fire({
                    icon: 'warning',
                    title: 'กรุณากรอกชื่อนักเรียน',
                    confirmButtonText: 'ตกลง',
                    confirmButtonColor: '#3085d6'
                });
                return;
            }
            
            Swal.fire({
                title: 'กำลังบันทึกข้อมูล',
                text: 'กรุณารอสักครู่...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            const studentData = {
                prefix,
                name
            };
            
            jsonpRequest(`${API_URL}?action=addStudent&prefix=${encodeURIComponent(prefix)}&name=${encodeURIComponent(name)}`, (data) => {
                if (data.success) {
                    hideAddStudentModal();
                    loadStudents();
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'เพิ่มนักเรียนสำเร็จ',
                        confirmButtonText: 'ตกลง',
                        confirmButtonColor: '#3085d6'
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: data.message || 'ไม่สามารถเพิ่มนักเรียนได้',
                        confirmButtonText: 'ตกลง',
                        confirmButtonColor: '#3085d6'
                    });
                }
            });
        }
        
        function deleteStudent(studentId) {
            Swal.fire({
                title: 'ยืนยันการลบ',
                text: 'คุณต้องการลบนักเรียนคนนี้ใช่หรือไม่?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'ใช่, ลบเลย',
                cancelButtonText: 'ยกเลิก'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'กำลังลบข้อมูล',
                        text: 'กรุณารอสักครู่...',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    jsonpRequest(`${API_URL}?action=deleteStudent&id=${studentId}`, (data) => {
                        if (data.success) {
                            loadStudents();
                            
                            Swal.fire({
                                icon: 'success',
                                title: 'ลบนักเรียนสำเร็จ',
                                confirmButtonText: 'ตกลง',
                                confirmButtonColor: '#3085d6'
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'เกิดข้อผิดพลาด',
                                text: data.message || 'ไม่สามารถลบนักเรียนได้',
                                confirmButtonText: 'ตกลง',
                                confirmButtonColor: '#3085d6'
                            });
                        }
                    });
                }
            });
        }
        
        // Attendance functions
        function saveAttendance() {
            const date = document.getElementById('attendanceDate').value;
            const dayType = document.querySelector('input[name="dayType"]:checked').value;
            
            if (!date) {
                Swal.fire({
                    icon: 'warning',
                    title: 'กรุณาเลือกวันที่',
                    confirmButtonText: 'ตกลง',
                    confirmButtonColor: '#3085d6'
                });
                return;
            }
            
            // Get attendance data
            const attendanceData = [];
            document.querySelectorAll('.attendance-status').forEach(select => {
                const studentId = select.dataset.studentId;
                const status = select.value;
                
                attendanceData.push({
                    studentId,
                    status
                });
            });
            
            Swal.fire({
                title: 'กำลังบันทึกข้อมูล',
                text: 'กรุณารอสักครู่...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            const dataParam = encodeURIComponent(JSON.stringify(attendanceData));
            jsonpRequest(`${API_URL}?action=saveAttendance&date=${date}&dayType=${dayType}&data=${dataParam}`, (data) => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'บันทึกข้อมูลสำเร็จ',
                        text: 'บันทึกข้อมูลการมาเรียนเรียบร้อยแล้ว',
                        confirmButtonText: 'ตกลง',
                        confirmButtonColor: '#3085d6'
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: data.message || 'ไม่สามารถบันทึกข้อมูลได้',
                        confirmButtonText: 'ตกลง',
                        confirmButtonColor: '#3085d6'
                    });
                }
            });
        }
        
        // Statistics functions
        function showStatsModal() {
            document.getElementById('statsModal').classList.remove('hidden');
            loadIndividualStats();
        }
        
        function hideStatsModal() {
            document.getElementById('statsModal').classList.add('hidden');
        }
        
        function switchStatsTab(tab) {
            // Update tab styling
            document.querySelectorAll('.stats-tab').forEach(t => {
                if (t.dataset.tab === tab) {
                    t.classList.remove('bg-gray-300', 'text-gray-800');
                    t.classList.add('bg-blue-600', 'text-white');
                } else {
                    t.classList.remove('bg-blue-600', 'text-white');
                    t.classList.add('bg-gray-300', 'text-gray-800');
                }
            });
            
            // Show/hide content
            document.querySelectorAll('.stats-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`${tab}Stats`).classList.remove('hidden');
            
            // Load data for the selected tab
            if (tab === 'individual') loadIndividualStats();
            else if (tab === 'daily') loadDailyStats();
            else if (tab === 'monthly') loadMonthlyStats();
        }
        
        function populateStudentDropdown() {
            const selectEl = document.getElementById('selectStudent');
            selectEl.innerHTML = '';
            
            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.prefix} ${student.name}`;
                selectEl.appendChild(option);
            });
            
            // Trigger stats load if dropdown is populated
            if (students.length > 0) {
                loadIndividualStats();
            }
        }
        
        function loadIndividualStats() {
            const studentId = document.getElementById('selectStudent').value;
            const month = document.getElementById('statsMonth').value;
            
            if (!studentId || !month) return;
            
            const contentEl = document.getElementById('individualStatsContent');
            contentEl.innerHTML = '<div class="loader"></div>';
            
            jsonpRequest(`${API_URL}?action=getIndividualStats&studentId=${studentId}&month=${month}`, (data) => {
                if (data.success) {
                    renderIndividualStats(data.stats, data.studentName);
                } else {
                    contentEl.innerHTML = `<div class="text-center text-red-500">เกิดข้อผิดพลาด: ${data.message || 'ไม่สามารถโหลดข้อมูลได้'}</div>`;
                }
            });
        }
        
        function renderIndividualStats(stats, studentName) {
            const contentEl = document.getElementById('individualStatsContent');
            
            if (!stats || stats.length === 0) {
                contentEl.innerHTML = '<div class="text-center text-gray-500 py-4">ไม่พบข้อมูลการมาเรียนในเดือนที่เลือก</div>';
                return;
            }
            
            let html = `
            <div class="bg-blue-50 p-4 rounded-lg mb-4">
                <h3 class="font-bold text-lg mb-2">สรุปการมาเรียนของ ${studentName}</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p><span class="font-medium">จำนวนวันเรียนทั้งหมด:</span> ${stats.totalSchoolDays} วัน</p>
                        <p><span class="font-medium">มาเรียน:</span> ${stats.present} วัน</p>
                        <p><span class="font-medium">ขาดเรียน:</span> ${stats.absent} วัน</p>
                    </div>
                    <div>
                        <p><span class="font-medium">ลาป่วย:</span> ${stats.sick} วัน</p>
                        <p><span class="font-medium">ลากิจ:</span> ${stats.personal} วัน</p>
                        <p><span class="font-medium">อัตราการมาเรียน:</span> ${stats.attendanceRate}%</p>
                    </div>
                </div>
            </div>
            
            <h3 class="font-bold text-lg mb-2">รายละเอียดรายวัน</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="py-2 px-4 border-b text-left">วันที่</th>
                            <th class="py-2 px-4 border-b text-left">สถานะ</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            stats.dailyRecords.forEach(record => {
                let statusText = 'มาเรียน';
                let statusClass = 'bg-green-100 text-green-800';
                
                if (record.status === 'absent') {
                    statusText = 'ขาดเรียน';
                    statusClass = 'bg-red-100 text-red-800 font-medium';
                } else if (record.status === 'sick') {
                    statusText = 'ลาป่วย';
                    statusClass = 'bg-blue-100 text-blue-800';
                } else if (record.status === 'personal') {
                    statusText = 'ลากิจ';
                    statusClass = 'bg-orange-100 text-orange-800';
                } else if (record.status === 'holiday') {
                    statusText = 'วันหยุด';
                    statusClass = 'bg-gray-100 text-gray-800';
                }
                
                html += `
                <tr class="border-b hover:bg-gray-50">
                    <td class="py-2 px-4">${record.date}</td>
                    <td class="py-2 px-4"><span class="px-2 py-1 rounded-full ${statusClass}">${statusText}</span></td>
                </tr>`;
            });
            
            html += `
                    </tbody>
                </table>
            </div>`;
            
            contentEl.innerHTML = html;
        }
        
        function loadDailyStats() {
            const date = document.getElementById('selectDate').value;
            
            if (!date) return;
            
            const contentEl = document.getElementById('dailyStatsContent');
            contentEl.innerHTML = '<div class="loader"></div>';
            
            jsonpRequest(`${API_URL}?action=getDailyStats&date=${date}`, (data) => {
                if (data.success) {
                    renderDailyStats(data.stats, date);
                } else {
                    contentEl.innerHTML = `<div class="text-center text-red-500">เกิดข้อผิดพลาด: ${data.message || 'ไม่สามารถโหลดข้อมูลได้'}</div>`;
                }
            });
        }
        
        function renderDailyStats(stats, date) {
            const contentEl = document.getElementById('dailyStatsContent');
            
            if (!stats) {
                contentEl.innerHTML = '<div class="text-center text-gray-500 py-4">ไม่พบข้อมูลการมาเรียนในวันที่เลือก</div>';
                return;
            }
            
            let html = `
            <div class="bg-blue-50 p-4 rounded-lg mb-4">
                <h3 class="font-bold text-lg mb-2">สรุปการมาเรียนวันที่ ${date}</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p><span class="font-medium">นักเรียนทั้งหมด:</span> ${stats.totalStudents} คน</p>
                        <p><span class="font-medium">มาเรียน:</span> ${stats.present} คน</p>
                        <p><span class="font-medium">ขาดเรียน:</span> ${stats.absent} คน</p>
                    </div>
                    <div>
                        <p><span class="font-medium">ลาป่วย:</span> ${stats.sick} คน</p>
                        <p><span class="font-medium">ลากิจ:</span> ${stats.personal} คน</p>
                        <p><span class="font-medium">อัตราการมาเรียน:</span> ${stats.attendanceRate}%</p>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h3 class="font-bold text-lg mb-2">นักเรียนที่มาเรียน</h3>
                    <ul class="list-disc pl-5 space-y-1">`;
            
            if (stats.presentStudents && stats.presentStudents.length > 0) {
                stats.presentStudents.forEach(student => {
                    html += `<li>${student}</li>`;
                });
            } else {
                html += `<li class="text-gray-500">ไม่มีนักเรียนมาเรียน</li>`;
            }
            
            html += `
                    </ul>
                </div>
                
                <div>
                    <h3 class="font-bold text-lg mb-2">นักเรียนที่ไม่มาเรียน</h3>
                    <ul class="list-disc pl-5 space-y-1">`;
            
            if (stats.absentStudents && stats.absentStudents.length > 0) {
                stats.absentStudents.forEach(student => {
                    let statusClass = '';
                    let statusText = '';
                    
                    if (student.status === 'absent') {
                        statusClass = 'text-red-600 font-medium';
                        statusText = 'ขาดเรียน';
                    } else if (student.status === 'sick') {
                        statusClass = 'text-blue-600';
                        statusText = 'ลาป่วย';
                    } else if (student.status === 'personal') {
                        statusClass = 'text-orange-600';
                        statusText = 'ลากิจ';
                    }
                    
                    html += `<li>${student.name} <span class="${statusClass}">(${statusText})</span></li>`;
                });
            } else {
                html += `<li class="text-gray-500">ไม่มีนักเรียนขาดเรียน</li>`;
            }
            
            html += `
                    </ul>
                </div>
            </div>`;
            
            contentEl.innerHTML = html;
        }
        
        function loadMonthlyStats() {
            const month = document.getElementById('statsMonth').value;
            
            if (!month) return;
            
            const contentEl = document.getElementById('monthlyStatsContent');
            contentEl.innerHTML = '<div class="loader"></div>';
            
            jsonpRequest(`${API_URL}?action=getMonthlyStats&month=${month}`, (data) => {
                if (data.success) {
                    renderMonthlyStats(data.stats, month);
                } else {
                    contentEl.innerHTML = `<div class="text-center text-red-500">เกิดข้อผิดพลาด: ${data.message || 'ไม่สามารถโหลดข้อมูลได้'}</div>`;
                }
            });
        }
        
        function renderMonthlyStats(stats, month) {
            const contentEl = document.getElementById('monthlyStatsContent');
            
            if (!stats || stats.students.length === 0) {
                contentEl.innerHTML = '<div class="text-center text-gray-500 py-4">ไม่พบข้อมูลการมาเรียนในเดือนที่เลือก</div>';
                return;
            }
            
            const [year, monthNum] = month.split('-');
            const monthName = new Date(year, monthNum - 1).toLocaleString('th-TH', { month: 'long' });
            
            let html = `
            <div class="bg-blue-50 p-4 rounded-lg mb-4">
                <h3 class="font-bold text-lg mb-2">สรุปการมาเรียนประจำเดือน${monthName} ${year}</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p><span class="font-medium">จำนวนวันเรียนทั้งหมด:</span> ${stats.totalSchoolDays} วัน</p>
                        <p><span class="font-medium">นักเรียนทั้งหมด:</span> ${stats.totalStudents} คน</p>
                    </div>
                    <div>
                        <p><span class="font-medium">อัตราการมาเรียนเฉลี่ย:</span> ${stats.averageAttendanceRate}%</p>
                    </div>
                </div>
            </div>
            
            <h3 class="font-bold text-lg mb-2">รายงานรายบุคคล</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="py-2 px-4 border-b text-left">ชื่อ-นามสกุล</th>
                            <th class="py-2 px-4 border-b text-center">มาเรียน</th>
                            <th class="py-2 px-4 border-b text-center">ขาดเรียน</th>
                            <th class="py-2 px-4 border-b text-center">ลาป่วย</th>
                            <th class="py-2 px-4 border-b text-center">ลากิจ</th>
                            <th class="py-2 px-4 border-b text-center">อัตราการมาเรียน</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            stats.students.forEach(student => {
                html += `
                <tr class="border-b hover:bg-gray-50">
                    <td class="py-2 px-4 font-medium">${student.name}</td>
                    <td class="py-2 px-4 text-center bg-green-50">${student.present} วัน</td>
                    <td class="py-2 px-4 text-center ${student.absent > 0 ? 'bg-red-50 text-red-600 font-medium' : ''}">${student.absent} วัน</td>
                    <td class="py-2 px-4 text-center ${student.sick > 0 ? 'bg-blue-50' : ''}">${student.sick} วัน</td>
                    <td class="py-2 px-4 text-center ${student.personal > 0 ? 'bg-orange-50' : ''}">${student.personal} วัน</td>
                    <td class="py-2 px-4 text-center">${student.attendanceRate}%</td>
                </tr>`;
                
                if (student.absent > 0 || student.sick > 0 || student.personal > 0) {
                    html += `
                    <tr class="bg-gray-50">
                        <td colspan="6" class="py-2 px-8 text-sm">
                            <span class="font-medium">วันที่ไม่มาเรียน:</span> `;
                    
                    if (student.absentDates && student.absentDates.length > 0) {
                        student.absentDates.forEach((date, i) => {
                            let statusClass = '';
                            let statusText = '';
                            
                            if (date.status === 'absent') {
                                statusClass = 'text-red-600 font-medium';
                                statusText = 'ขาดเรียน';
                            } else if (date.status === 'sick') {
                                statusClass = 'text-blue-600';
                                statusText = 'ลาป่วย';
                            } else if (date.status === 'personal') {
                                statusClass = 'text-orange-600';
                                statusText = 'ลากิจ';
                            }
                            
                            html += `${date.date} <span class="${statusClass}">(${statusText})</span>${i < student.absentDates.length - 1 ? ', ' : ''}`;
                        });
                    } else {
                        html += `<span class="text-gray-500">ไม่มีข้อมูล</span>`;
                    }
                    
                    html += `
                        </td>
                    </tr>`;
                }
            });
            
            html += `
                    </tbody>
                </table>
            </div>`;
            
            contentEl.innerHTML = html;
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'940176c4f03dff87',t:'MTc0NzI5OTgyNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
