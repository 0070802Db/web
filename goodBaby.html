<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f8ff; /* Light Alice Blue - Whiteish */
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            background-color: #ffffff; /* White */
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 800px;
            margin-bottom: 20px;
        }

        h1, h2 {
            color: #483D8B; /* Dark Slate Blue - Navy variant */
            text-align: center;
        }

        label {
            display: block;
            margin-top: 10px;
            margin-bottom: 5px;
            color: #6A5ACD; /* Slate Blue - Purple variant */
            font-weight: bold;
        }

        input[type="text"],
        input[type="password"],
        input[type="date"],
        input[type="number"],
        select {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ADD8E6; /* Light Blue */
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            background-color: #8A2BE2; /* Blue Violet - Purple */
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 5px;
            margin-right: 5px;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #9370DB; /* Medium Purple */
        }

        .login-section button {
            background-color: #0000FF; /* Blue */
        }
        .login-section button:hover {
            background-color: #4169E1; /* Royal Blue */
        }


        .admin-controls button.delete {
            background-color: #FF69B4; /* Hot Pink */
        }
        .admin-controls button.delete:hover {
            background-color: #FFC0CB; /* Pink */
        }


        #logoutButton, button.admin-logout { /* Target both potential logout buttons */
            background-color: #DC143C !important; /* Crimson - For logout */
        }
        #logoutButton:hover, button.admin-logout:hover {
            background-color: #FF6347 !important; /* Tomato */
        }


        .admin-controls, .stats-section, .daily-summary, .monthly-stats {
            border: 1px solid #DB7093; /* Pale Violet Red - Pinkish border */
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
            background-color: #FFF0F5; /* Lavender Blush - Light Pinkish white */
        }

        .hidden {
            display: none;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            border: 1px solid #ADD8E6; /* Light Blue */
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #B0E0E6; /* Powder Blue */
            color: #483D8B; /* Dark Slate Blue */
        }

        td {
             background-color: #ffffff;
        }

        .score-controls {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .score-controls button {
            min-width: 40px;
            font-size: 1.2em;
            background-color: #4682B4; /* Steel Blue */
        }
         .score-controls button:hover {
            background-color: #5F9EA0; /* Cadet Blue */
        }


        #currentScoreDisplay {
            font-size: 1.5em;
            margin: 0 15px;
            color: #0000CD; /* Medium Blue */
            font-weight: bold;
            min-width: 50px; /* Ensure some space for the number */
            text-align: center;
        }
        #adminStatus {
            text-align: right;
            font-weight: bold;
            color: #8A2BE2; /* Blue Violet */
            margin-bottom: 10px;
        }

    </style>
</head>
<body>

    <div class="container" id="loginSection">
        <h1>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h1>
        <label for="username">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:</label>
        <input type="text" id="username" value="admin">
        <label for="password">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô:</label>
        <input type="password" id="password" value="1234">
        <button onclick="handleLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <div class="container hidden" id="mainAppSection">
        <div id="adminStatus">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ <button id="logoutButton" class="hidden" onclick="handleLogout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button></div>
        <h1>üìù ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ</h1>

        <label for="recordDate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô:</label>
        <input type="date" id="recordDate">

        <div id="adminControlsSection" class="admin-controls hidden">
            <h2>‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
            <label for="newStudentName">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà:</label>
            <input type="text" id="newStudentName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
            <button onclick="handleAddStudent()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
            <hr>
            <label for="deleteStudentSelect">‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</label>
            <select id="deleteStudentSelect"></select>
            <button class="delete" onclick="handleDeleteStudent()">‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
        </div>

        <h2>‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
        <label for="studentSelect">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</label>
        <select id="studentSelect"></select>

        <label>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á):</label>
        <div class="score-controls">
            <button onclick="decreaseScore()">-5</button>
            <span id="currentScoreDisplay">0</span>
            <button onclick="increaseScore()">+5</button>
        </div>
        <button onclick="handleSaveDeed()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>

        <div class="daily-summary">
            <h2>üåü ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô (‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô)</h2>
            <button onclick="fetchDailySummary()">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</button>
            <div id="dailySummaryOutput">
                <p>‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
            </div>
        </div>

        <div class="monthly-stats">
            <h2>üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</h2>
            <label for="statsMonth">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</label>
            <select id="statsMonth">
                <option value="1">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
                <option value="2">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
                <option value="3">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                <option value="4">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
                <option value="5">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
                <option value="6">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                <option value="7">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
                <option value="8">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
                <option value="9">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
                <option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
                <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
            </select>
            <label for="statsYear">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ:</label>
            <input type="number" id="statsYear" min="2020" max="2099" value=""> <button onclick="fetchMonthlyStats()">‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
            <div id="monthlyStatsOutput">
                <p>‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏µ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
            </div>
        </div>
    </div>

    <script>
        let isAdmin = false;
        let currentScoreOnForm = 0;
        let studentBaseScore = 0;
        let studentsList = [];
        // !!! IMPORTANT: This URL must be your deployed Google Apps Script Web App URL !!!
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbxM_03clQopSrztoU5GRPOIodoIoqPhOnoNtTPQQysJyS4MQxEH-WAngu7u-XwNCZFxyQ/exec';

        const loginSection = document.getElementById('loginSection');
        const mainAppSection = document.getElementById('mainAppSection');
        const adminControlsSection = document.getElementById('adminControlsSection');
        const adminStatusDiv = document.getElementById('adminStatus');
        let logoutButton = document.getElementById('logoutButton'); // Make it updatable
        const recordDateInput = document.getElementById('recordDate');
        const studentSelect = document.getElementById('studentSelect');
        const deleteStudentSelect = document.getElementById('deleteStudentSelect');
        const newStudentNameInput = document.getElementById('newStudentName');
        const currentScoreDisplay = document.getElementById('currentScoreDisplay');
        const dailySummaryOutput = document.getElementById('dailySummaryOutput');
        const monthlyStatsOutput = document.getElementById('monthlyStatsOutput');
        const statsMonthInput = document.getElementById('statsMonth');
        const statsYearInput = document.getElementById('statsYear');

        let scriptTagIdCounter = 0;
        function jsonpRequest(params, callbackName) {
            const scriptId = `jsonp-script-${scriptTagIdCounter++}`;
            params.callback = callbackName;
            const queryString = Object.keys(params).map(key => `${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`).join('&');
            
            const script = document.createElement('script');
            script.id = scriptId;
            script.src = `${GAS_URL}?${queryString}`;
            
            script.onerror = () => {
                Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ (JSONP Error)', 'error');
                document.getElementById(scriptId)?.remove();
                if(window[callbackName]) {
                    window[callbackName]({status: 'error', message: 'JSONP Script load error'});
                    delete window[callbackName]; 
                }
            };
            document.body.appendChild(script);
            // Callback function itself should call cleanupJsonpScript(script.id)
        }
        
        function cleanupJsonpScript(scriptId) {
            const scriptElement = document.getElementById(scriptId);
            if (scriptElement) {
                scriptElement.remove();
            }
        }

        function handleLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            if (username === 'admin' && password === '1234') {
                isAdmin = true;
                loginSection.classList.add('hidden');
                mainAppSection.classList.remove('hidden');
                adminControlsSection.classList.remove('hidden');
                adminStatusDiv.innerHTML = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö <button class="admin-logout" id="logoutButtonDynamic" onclick="handleLogout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>';
                logoutButton = document.getElementById('logoutButtonDynamic'); // Re-assign to the new button
                if(logoutButton) logoutButton.classList.remove('hidden');
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
            } else {
                isAdmin = false;
                loginSection.classList.add('hidden');
                mainAppSection.classList.remove('hidden');
                adminControlsSection.classList.add('hidden');
                adminStatusDiv.innerHTML = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ <button id="logoutButton" class="hidden" onclick="handleLogout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>';
                logoutButton = document.getElementById('logoutButton'); // Re-assign
                if(logoutButton) logoutButton.classList.add('hidden'); // Ensure it's hidden for general user
                Swal.fire('‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö!', '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ', 'info');
            }
            initApp();
        }

        function handleLogout() {
            isAdmin = false;
            mainAppSection.classList.add('hidden');
            loginSection.classList.remove('hidden');
            document.getElementById('username').value = "admin"; // Reset login form for convenience
            document.getElementById('password').value = "1234";
            adminStatusDiv.textContent = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'; // This might be overwritten by login screen
            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
        }
        
        function fetchStudents() {
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...', allowOutsideClick: false, didOpen: () => { Swal.showLoading() } });
            const callbackName = 'populateStudentsCallback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
            window[callbackName] = (data) => {
                const currentScript = document.querySelector(`script[src*="${callbackName}"]`);
                populateStudentsCallback(data);
                delete window[callbackName]; 
                if (currentScript) cleanupJsonpScript(currentScript.id);
            };
            jsonpRequest({ action: 'getStudents' }, callbackName);
        }

        function populateStudentsCallback(data) {
            Swal.close();
            if (data && data.status === 'success' && data.students) {
                studentsList = data.students;
                studentSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô --</option>';
                deleteStudentSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö --</option>';
                studentsList.forEach(student => {
                    studentSelect.innerHTML += `<option value="${student}">${student}</option>`;
                    if (isAdmin) {
                        deleteStudentSelect.innerHTML += `<option value="${student}">${student}</option>`;
                    }
                });
            } else {
                 Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ' + (data && data.message ? `: ${data.message}` : ''), 'error');
            }
        }
        
        function handleAddStudent() {
            const name = newStudentNameInput.value.trim();
            if (!name) {
                Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', 'warning');
                return;
            }
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...', allowOutsideClick: false, didOpen: () => { Swal.showLoading() } });
            const callbackName = 'addStudentCallback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
            window[callbackName] = (response) => {
                const currentScript = document.querySelector(`script[src*="${callbackName}"]`);
                addStudentCallback(response);
                delete window[callbackName];
                if (currentScript) cleanupJsonpScript(currentScript.id);
            };
            jsonpRequest({ action: 'addStudent', name: name }, callbackName);
        }

        function addStudentCallback(response) {
            if (response && response.status === 'success') {
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', response.message, 'success');
                newStudentNameInput.value = '';
                fetchStudents(); 
            } else {
                Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', (response && response.message) || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ', 'error');
            }
        }

        function handleDeleteStudent() {
            const name = deleteStudentSelect.value;
            if (!name) {
                Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö', 'warning');
                return;
            }
            Swal.fire({
                title: '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
                text: `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô "${name}" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏•‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ)`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡πÄ‡∏•‡∏¢!',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...', allowOutsideClick: false, didOpen: () => { Swal.showLoading() } });
                    const callbackName = 'deleteStudentCallback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
                    window[callbackName] = (response) => {
                        const currentScript = document.querySelector(`script[src*="${callbackName}"]`);
                        deleteStudentCallback(response);
                        delete window[callbackName];
                        if (currentScript) cleanupJsonpScript(currentScript.id);
                    };
                    jsonpRequest({ action: 'deleteStudent', name: name }, callbackName);
                }
            });
        }

        function deleteStudentCallback(response) {
             if (response && response.status === 'success') {
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', response.message, 'success');
                fetchStudents(); 
            } else {
                Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', (response && response.message) || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ', 'error');
            }
        }

        function fetchStudentCurrentTotalScore(studentName) {
            if (!studentName) {
                studentBaseScore = 0;
                currentScoreOnForm = 0;
                updateScoreDisplay();
                return;
            }
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô...', allowOutsideClick: false, didOpen: () => { Swal.showLoading() }});
            const callbackName = 'fetchStudentScoreCallback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
            window[callbackName] = (data) => {
                const currentScript = document.querySelector(`script[src*="${callbackName}"]`);
                Swal.close();
                if (data && data.status === 'success' && data.studentName === studentName) {
                    studentBaseScore = data.totalScore;
                    currentScoreOnForm = data.totalScore;
                } else {
                    studentBaseScore = 0; 
                    currentScoreOnForm = 0;
                    if (data && data.status === 'error') {
                        console.error("Fetch score error for " + studentName + ": " + data.message);
                    }
                }
                updateScoreDisplay();
                delete window[callbackName];
                if (currentScript) cleanupJsonpScript(currentScript.id);
            };
            jsonpRequest({ action: 'getStudentCurrentScore', student: studentName }, callbackName);
        }

        function updateScoreDisplay() {
            currentScoreDisplay.textContent = currentScoreOnForm;
        }

        function increaseScore() {
            currentScoreOnForm += 5;
            updateScoreDisplay();
        }

        function decreaseScore() {
            currentScoreOnForm -= 5;
            if (currentScoreOnForm < 0) { 
                currentScoreOnForm = 0;
            }
            updateScoreDisplay();
        }

        function handleSaveDeed() {
            const date = recordDateInput.value;
            const student = studentSelect.value;
            const finalScoreOnForm = currentScoreOnForm;

            if (!date) {
                Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'warning');
                return;
            }
            if (!student) {
                Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', 'warning');
                return;
            }

            const pointsForThisDeed = finalScoreOnForm - studentBaseScore;

            if (pointsForThisDeed === 0) {
                Swal.fire('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á', '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏¥‡∏°', 'info');
                return;
            }

            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô...', allowOutsideClick: false, didOpen: () => { Swal.showLoading() } });
            const callbackName = 'saveDeedCallback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
            window[callbackName] = (response) => {
                const currentScript = document.querySelector(`script[src*="${callbackName}"]`);
                saveDeedCallback(response, finalScoreOnForm);
                delete window[callbackName];
                if (currentScript) cleanupJsonpScript(currentScript.id);
            };
            jsonpRequest({ action: 'logGoodDeed', date: date, student: student, points: pointsForThisDeed }, callbackName);
        }

        function saveDeedCallback(response, newTotalScoreForStudent) {
            if (response && response.status === 'success') {
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', response.message, 'success');
                studentBaseScore = newTotalScoreForStudent; 
                currentScoreOnForm = newTotalScoreForStudent; 
                updateScoreDisplay();
                fetchDailySummary(); 
            } else {
                Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', (response && response.message) || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
                if(studentSelect.value) { // Attempt to re-fetch score if a student is selected
                    fetchStudentCurrentTotalScore(studentSelect.value);
                }
            }
        }

        function fetchDailySummary() {
            const date = recordDateInput.value;
            if (!date) {
                dailySummaryOutput.innerHTML = "<p>‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</p>";
                return;
            }
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô...', allowOutsideClick: false, didOpen: () => { Swal.showLoading() } });
            const callbackName = 'displayDailySummaryCallback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
            window[callbackName] = (data) => {
                const currentScript = document.querySelector(`script[src*="${callbackName}"]`);
                displayDailySummaryCallback(data); // Swal.close() is inside this function
                delete window[callbackName];
                if (currentScript) cleanupJsonpScript(currentScript.id);
            };
            jsonpRequest({ action: 'getDailySummary', date: date }, callbackName);
        }

        function displayDailySummaryCallback(data) {
            Swal.close(); 
            if (data && data.status === 'success') {
                let html = `<h3>‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${recordDateInput.value}</h3>`;
                html += `<p><strong>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: ${data.dailyTotal} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</strong></p>`;
                if (data.summary && data.summary.length > 0) {
                    html += `<table>
                                <tr>
                                    <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                                    <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                                    <th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th>
                                    <th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</th>
                                </tr>`;
                    data.summary.forEach((item, index) => {
                        html += `<tr>
                                    <td>${index + 1}</td>
                                    <td>${item.studentName}</td>
                                    <td>${item.totalAccumulatedScore}</td>
                                    <td>${item.scoreForSelectedDate}</td>
                                 </tr>`;
                    });
                    html += `</table>`;
                } else {
                    html += "<p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>";
                }
                dailySummaryOutput.innerHTML = html;
            } else {
                dailySummaryOutput.innerHTML = "<p>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</p>";
                Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô: ' + (data && data.message ? data.message : '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'), 'error');
            }
        }

        function fetchMonthlyStats() {
            const month = statsMonthInput.value;
            const year = statsYearInput.value;
            if (!month || !year) {
                Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏µ', 'info');
                return;
            }
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô...', allowOutsideClick: false, didOpen: () => { Swal.showLoading() } });
            const callbackName = 'displayMonthlyStatsCallback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
            window[callbackName] = (data) => {
                const currentScript = document.querySelector(`script[src*="${callbackName}"]`);
                displayMonthlyStatsCallback(data); // Swal.close() is inside this function
                delete window[callbackName];
                if (currentScript) cleanupJsonpScript(currentScript.id);
            };
            jsonpRequest({ action: 'getMonthlyStats', month: month, year: year }, callbackName);
        }

        function displayMonthlyStatsCallback(data) {
            Swal.close();
             if (data && data.status === 'success') {
                const monthName = statsMonthInput.options[statsMonthInput.selectedIndex].text;
                let html = `<h3>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${monthName} ‡∏õ‡∏µ ${statsYearInput.value}</h3>`;
                if (data.stats && data.stats.length > 0) {
                    html += `<table>
                                <tr>
                                    <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                                    <th>‡∏¢‡∏≠‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th>
                                </tr>`;
                    data.stats.forEach(item => {
                        html += `<tr>
                                    <td>${item.studentName}</td>
                                    <td>${item.totalMonthlyScore}</td>
                                 </tr>`;
                    });
                    html += `</table>`;
                } else {
                    html += "<p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</p>";
                }
                monthlyStatsOutput.innerHTML = html;
            } else {
                monthlyStatsOutput.innerHTML = "<p>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>";
                Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ' + (data && data.message ? data.message : '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'), 'error');
            }
        }

        function initApp() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            recordDateInput.value = `${yyyy}-${mm}-${dd}`;

            statsMonthInput.value = today.getMonth() + 1;
            statsYearInput.value = yyyy; // Set current year for stats year input

            studentSelect.addEventListener('change', function() {
                fetchStudentCurrentTotalScore(this.value);
            });

            fetchStudents(); 
            updateScoreDisplay(); 
            if (!mainAppSection.classList.contains('hidden')) {
                 fetchDailySummary();
            }
        }
        
    </script>
</body>
</html>
